---
title: "Data Processing"
author: "Me"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
# Load packages
library(blackmarbler)
library(geodata)
library(sf)
library(terra)
library(ggplot2)
library(tidyterra)
library(lubridate)
library(dplyr)
library(tmap)
library(raster)
library(rnaturalearth)
library(jsonlite)
library(dplyr)
library(tools)


config <- fromJSON("~/Local/Dissertation/NTL_Wildfire_Recovery/data_config.json")
print(config$data_path)

satellite_results <- read.csv("~/Library/CloudStorage/OneDrive-LondonSchoolofEconomics/wildfire_recovery_ntl_data/raw/satellite_results.csv")
#buffer_results <- read.csv("~/Library/CloudStorage/OneDrive-LondonSchoolofEconomics/wildfire_recovery_ntl_data/raw/buffer_results.csv")

# Load satellite data
satellite_outputs <- list.files("~/Local/Dissertation/NTL_Wildfire_Recovery/satellite_outputs", full.names = TRUE)

# filter files from he satellite output folder that are pngs, and older keep files that are TIFs
satellite_outputs <- satellite_outputs[grepl("tif$", satellite_outputs)]

satellite_data <- lapply(satellite_outputs, rast)

# Name the output rasters in satellite data based on the file names 
# Extract file names without extension and path
file_names <- tools::file_path_sans_ext(basename(satellite_outputs))

# Name the list elements using extracted file names
names(satellite_data) <- file_names

# Check the names
print(names(satellite_data))
plot(satellite_data[[811]])
# satellite csv
satellite_results <- read.csv("~/Local/Dissertation/NTL_Wildfire_Recovery/satellite_results.csv")

# Check structure
str(satellite_results)

# Preview first few rows
head(satellite_results)


# Clean raster_path in CSV to match raster file names
satellite_results <- satellite_results %>%
  mutate(raster_name = file_path_sans_ext(basename(raster_path)))

# Merge rasters with their corresponding metadata
combined_data <- lapply(names(satellite_data), function(name) {
  list(
    raster = satellite_data[[name]],
    metadata = satellite_results %>% filter(raster_name == name)
  )
})

# Assign names to the combined list
names(combined_data) <- names(satellite_data)

# Check merged structure
summary(combined_data)
plot(combined_data[[2]]$raster)

```


You can also embed plots, for example:

```{r pressure, echo=FALSE}
# Process data 


    kmz_file <- "~/Downloads/USA_Flares.kmz"
    sf_data <- st_read(kmz_file, driver = "KML")


install.packages("rgdal", type = "source", configure.args = c("--with-proj-include=/usr/local/include", "--with-proj-lib=/usr/local/lib"))

unzip("~/Downloads/USA_Flares.kmz", exdir = "kmz_unzipped")

kml_file <- list.files("kmz_unzipped", pattern = "\\.kml$", full.names = TRUE)[1]  # Get the KML file
kmz_data <- st_read(kml_file)

sat_df <- 
input_dir <- normalizePath("~/Local/Dissertation/NTL_Wildfire_Recovery/satellite_outputs)


```

```{r}
# Plot the data


```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
