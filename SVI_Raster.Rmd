---
title: "Raster_SVI"
author: "Josie Zenger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(sf)
library(tidyverse)
library(terra)
library(tmap)
library(dplyr)

```

```{r}

# Point to the geodatabase
gdb_path <- "~/Downloads/SVI2018_CALIFORNIA_tract.gdb"

# List all layers in the GDB
st_layers(gdb_path)

# Read the tract layer (adjust layer name if needed)
tracts <- st_read(gdb_path, layer = "SVI2018_CALIFORNIA_tract")

# Filter for Butte County
butte_tracts <- tracts %>% filter(STCNTY == "06007")

# Load in the fire roi shapefile
camp_fire <- st_read("~/Local/Dissertation/camp_sf/camp_fire.shp")

# Reproject Camp Fire to match tracts
camp_fire <- st_transform(camp_fire, st_crs(butte_tracts))

# Get census tracts that intersect the fire
tracts_hit <- st_filter(butte_tracts, camp_fire, .predicate = st_intersects)


ggplot() +
  geom_sf(data = butte_tracts, fill = "white", color = "grey90") +
  geom_sf(data = tracts_hit, fill = "red", alpha = 0.5) +
  geom_sf(data = camp_fire, fill = NA, color = "black") +
  theme_minimal() +
  labs(title = "Camp Fire Affected Census Tracts in Butte County")


```

```{r}

# Replace with the actual file name once known
burn_path <- file.path("~/Downloads/ca3982012144020181108_20171207_20181210_ravg_data/ca3982012144020181108_20171207_20181210_rdnbr_cc5.tif")

# Load the raster
burn_raster <- rast(burn_path)
plot(burn_raster)

# Convert to terra SpatVector
tracts_vect <- vect(tracts_hit)
plot(tracts_vect)


# Extract the **mean** raster value per tract
burn_extract <- terra::extract(burn_raster, tracts_vect, fun = mean, na.rm = TRUE)

burn_summary <- burn_extract %>%
  group_by(ID) %>%
  summarize(mean_burn = mean(Layer_1, na.rm = TRUE))

tracts_with_burn <- bind_cols(tracts_hit, burn_summary)

# Turn on interactive or static mode
tmap_mode("plot")  # or "view" for leaflet-style interactivity

# Create the map
tm_shape(tracts_with_burn) +
  tm_fill(
    col = "mean_burn",
    palette = "inferno",
    style = "cont",
    title = "Mean Burn Severity",
    textNA = "No data",
    colorNA = "grey90"
  ) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_shape(camp_fire) +
  tm_borders(col = "lightblue", lwd = 1.2, lty = "solid") +
  tm_layout(
    title = "Mean Burn Severity in Camp Fireâ€“Affected Census Tracts",
    legend.outside = TRUE,
    frame = FALSE
  )


```

```{r}
# Load shapefiles 

camp_sf <- st_read("~/Local/Dissertation/NTL_Wildfire_Recovery/camp_sf/camp_fire.shp")
#buffer_sf <- st_read("~/Local/Dissertation/camp_fire_buffer/camp_fire_buffer.shp")
tracts <- st_read("~/Downloads/tl_2018_06_tract/tl_2018_06_tract.shp")

tracts <- st_transform(tracts, st_crs(camp_sf))

# Filter tracts to be just Butte County
tracts <- tracts %>% filter(COUNTYFP == "007")

# Filter for only tracts that intersect with the Camp Fire area
camp_tracts <- st_filter(tracts, camp_sf, .predicate = st_intersects)
# buffer_tracts <- st_filter(tracts, buffer_sf, .predicate = st_intersects)

plot(camp_tracts, col = "red", main = "Census Tracts Affected by Camp Fire")
# plot(buffer_tracts, col = "blue", main = "Census Tracts in Camp Fire Buffer Area")

# Filter out tract 15
camp_tracts <- camp_tracts %>% filter(GEOID != "06007001500")

plot(camp_tracts$geometry, col = "red", main = "Census Tracts Affected by Camp Fire (Excluding Tract 15)")





```

```{r}
library(terra)
library(sf)
library(dplyr)
library(lubridate)
library(tidyr)

# Step 1: Load raster and metadata (assumes previous steps already run)
# camp_data: named list of rasters
# c.combined_data: list of list(raster, metadata)
# camp_tracts: filtered sf for Camp Fire-affected tracts

# Step 2: Extract NTL values by census tract for each raster

extracted_data <- lapply(names(c.combined_data), function(name) {
  raster_layer <- c.combined_data[[name]]$raster
  
  # Extract mean raster values per tract
  extracted <- terra::extract(raster_layer, vect(camp_tracts), fun = mean, na.rm = TRUE)
  
  # Add tract ID and metadata
  extracted$TRACTCE <- camp_tracts$TRACTCE
  extracted$system.index <- name
  
  # Convert the 'name' (string) to Date, assign as date column
  # Adjust format if needed, e.g. "2023-05-10" or parse accordingly
  extracted$date <- as.Date(name)  # or parse_date_time(name, orders = c("ymd", "ymd HMS")) if complex
  
  return(extracted)
})


# Step 3: Combine into one dataframe
extracted_df <- do.call(rbind, extracted_data)

# Step 4: Convert date and extract month/year
extracted_df <- extracted_df %>%
  mutate(date = ymd(date),
         year = year(date),
         month = month(date)) %>%
  rename(mean_ntl = 2)

# Step 5: Group by tract and month, compute monthly average NTL
monthly_avg_ntl <- extracted_df %>%
  group_by(TRACTCE, year, month) %>%
  summarise(avg_ntl = mean(mean_ntl, na.rm = TRUE), .groups = "drop") %>%
  mutate(month_start = as.Date(paste(year, month, "01", sep = "-")))

fire_date <- ymd("2018-11-01")

monthly_avg_ntl <- monthly_avg_ntl %>%
  mutate(months_since_fire = 
           (year(month_start) - year(fire_date)) * 12 +
           (month(month_start) - month(fire_date)))

# Step 6: View result
print(head(monthly_avg_ntl))



```
```{r}
# combine monthly ntl with the california svi data 
svi_data <- read.csv("~/Local/Dissertation/NTL_Wildfire_Recovery/CaliforniaSVI.csv")

# Extract tract
svi_data <- svi_data %>%
  filter(COUNTY == "Butte")

svi_data <- svi_data %>%
  mutate(
    # Extract tract number from label
    LOCATION = str_extract(LOCATION, "(?<=Census Tract )[0-9\\.]+"),
    
    # Convert to 6-digit padded character, like "000901"
    TRACTCE = str_pad(sprintf("%06d", as.integer(as.numeric(tract_num) * 100)), 6, pad = "0")
  )

# combine the two data sets together
svi_monthly <- monthly_avg_ntl %>%
  left_join(svi_data, by = "TRACTCE") %>%
  select(TRACTCE, RPL_THEMES, avg_ntl, months_since_fire, month) 

write.csv(svi_monthly, "~/Local/Dissertation/NTL_Wildfire_Recovery/svi_monthly.csv", row.names = FALSE)

```



```{r}
library(fixest)

model <- feols(avg_ntl ~ i(months_since_fire, RPL_THEMES, ref = 0) | TRACTCE, data = svi_monthly, 
               cluster = ~ TRACTCE)
summary(model)
```