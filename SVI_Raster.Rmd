---
title: "Raster_SVI"
author: "Josie Zenger"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(sf)
library(tidyverse)
library(terra)
library(tmap)
library(dplyr)

```

```{r}

# Point to the geodatabase
gdb_path <- "~/Downloads/SVI2018_CALIFORNIA_tract.gdb"

# List all layers in the GDB
st_layers(gdb_path)

# Read the tract layer (adjust layer name if needed)
tracts <- st_read(gdb_path, layer = "SVI2018_CALIFORNIA_tract")

# Filter for Butte County
butte_tracts <- tracts %>% filter(STCNTY == "06007")

# Load in the fire roi shapefile
camp_fire <- st_read("~/Local/Dissertation/camp_sf/camp_fire.shp")

# Reproject Camp Fire to match tracts
camp_fire <- st_transform(camp_fire, st_crs(butte_tracts))

# Get census tracts that intersect the fire
tracts_hit <- st_filter(butte_tracts, camp_fire, .predicate = st_intersects)


ggplot() +
  geom_sf(data = butte_tracts, fill = "white", color = "grey90") +
  geom_sf(data = tracts_hit, fill = "red", alpha = 0.5) +
  geom_sf(data = camp_fire, fill = NA, color = "black") +
  theme_minimal() +
  labs(title = "Camp Fire Affected Census Tracts in Butte County")


```

```{r}

# Replace with the actual file name once known
burn_path <- file.path("~/Downloads/ca3982012144020181108_20171207_20181210_ravg_data/ca3982012144020181108_20171207_20181210_rdnbr_cc5.tif")

# Load the raster
burn_raster <- rast(burn_path)
plot(burn_raster)

# Convert to terra SpatVector
tracts_vect <- vect(tracts_hit)
plot(tracts_vect)


# Extract the **mean** raster value per tract
burn_extract <- terra::extract(burn_raster, tracts_vect, fun = mean, na.rm = TRUE)

burn_summary <- burn_extract %>%
  group_by(ID) %>%
  summarize(mean_burn = mean(Layer_1, na.rm = TRUE))

tracts_with_burn <- bind_cols(tracts_hit, burn_summary)

# Turn on interactive or static mode
tmap_mode("plot")  # or "view" for leaflet-style interactivity

# Create the map
tm_shape(tracts_with_burn) +
  tm_fill(
    col = "mean_burn",
    palette = "inferno",
    style = "cont",
    title = "Mean Burn Severity",
    textNA = "No data",
    colorNA = "grey90"
  ) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_shape(camp_fire) +
  tm_borders(col = "lightblue", lwd = 1.2, lty = "solid") +
  tm_layout(
    title = "Mean Burn Severity in Camp Fireâ€“Affected Census Tracts",
    legend.outside = TRUE,
    frame = FALSE
  )


```

```{r}
# Load shapefiles 

camp_sf <- st_read("~/Local/Dissertation/NTL_Wildfire_Recovery/camp_sf/camp_fire.shp")
#buffer_sf <- st_read("~/Local/Dissertation/camp_fire_buffer/camp_fire_buffer.shp")
tracts <- st_read("~/Downloads/tl_2018_06_tract/tl_2018_06_tract.shp")

tracts <- st_transform(tracts, st_crs(camp_sf))

# Filter tracts to be just Butte County
tracts <- tracts %>% filter(COUNTYFP == "007")

# Filter for only tracts that intersect with the Camp Fire area
camp_tracts <- st_filter(tracts, camp_sf, .predicate = st_intersects)
# buffer_tracts <- st_filter(tracts, buffer_sf, .predicate = st_intersects)

plot(camp_tracts, col = "red", main = "Census Tracts Affected by Camp Fire")
# plot(buffer_tracts, col = "blue", main = "Census Tracts in Camp Fire Buffer Area")

# Filter out tract 15
camp_tracts <- camp_tracts %>% filter(GEOID != "06007001500")

plot(camp_tracts$geometry, col = "red", main = "Census Tracts Affected by Camp Fire (Excluding Tract 15)")





```

```{r}
library(terra)
library(sf)
library(dplyr)
library(lubridate)
library(tidyr)

# Step 1: Load raster and metadata (assumes previous steps already run)
# camp_data: named list of rasters
# c.combined_data: list of list(raster, metadata)
# camp_tracts: filtered sf for Camp Fire-affected tracts

# Step 2: Extract NTL values by census tract for each raster

extracted_data <- lapply(names(c.combined_data), function(name) {
  raster_layer <- c.combined_data[[name]]$raster
  
  # Extract mean raster values per tract
  extracted <- terra::extract(raster_layer, vect(camp_tracts), fun = mean, na.rm = TRUE)
  
  # Add tract ID and metadata
  extracted$TRACTCE <- camp_tracts$TRACTCE
  extracted$system.index <- name
  
  # Convert the 'name' (string) to Date, assign as date column
  # Adjust format if needed, e.g. "2023-05-10" or parse accordingly
  extracted$date <- as.Date(name)  # or parse_date_time(name, orders = c("ymd", "ymd HMS")) if complex
  
  return(extracted)
})


# Step 3: Combine into one dataframe
extracted_df <- do.call(rbind, extracted_data)

# Step 4: Convert date and extract month/year
extracted_df <- extracted_df %>%
  mutate(date = ymd(date),
         year = year(date),
         month = month(date)) %>%
  rename(mean_ntl = 2)

# Step 5: Group by tract and month, compute monthly average NTL
monthly_avg_ntl <- extracted_df %>%
  group_by(TRACTCE, year, month) %>%
  summarise(avg_ntl = mean(mean_ntl, na.rm = TRUE), .groups = "drop") %>%
  mutate(month_start = as.Date(paste(year, month, "01", sep = "-")))

fire_date <- ymd("2018-11-01")

monthly_avg_ntl <- monthly_avg_ntl %>%
  mutate(months_since_fire = 
           (year(month_start) - year(fire_date)) * 12 +
           (month(month_start) - month(fire_date)))

# Step 6: View result
print(head(monthly_avg_ntl))



```
```{r}
# combine monthly ntl with the california svi data 
svi_data <- read.csv("~/Local/Dissertation/NTL_Wildfire_Recovery/CaliforniaSVI.csv")

# Extract tract
svi_data <- svi_data %>%
  filter(COUNTY == "Butte")

svi_data <- svi_data %>%
  mutate(
    # Extract tract number from label
    LOCATION = str_extract(LOCATION, "(?<=Census Tract )[0-9\\.]+"),
    
    # Convert to 6-digit padded character, like "000901"
    TRACTCE = str_pad(sprintf("%06d", as.integer(as.numeric(tract_num) * 100)), 6, pad = "0")
  )

# combine the two data sets together
svi_monthly <- monthly_avg_ntl %>%
  left_join(svi_data, by = "TRACTCE") %>%
  select(TRACTCE, RPL_THEMES, avg_ntl, months_since_fire, month, E_TOTPOP) %>% 
  filter(months_since_fire >= 1)

write.csv(svi_monthly, "~/Local/Dissertation/NTL_Wildfire_Recovery/svi_monthly.csv", row.names = FALSE)



```

```{r}

model_varying_slopes <- lm(avg_ntl ~ log1p(months_since_fire) * factor(TRACTCE) + E_TOTPOP, data = svi_monthly)
summary(model_varying_slopes)

# Step 1: Identify significant tracts
significant_tracts <- c("1600", "2200")

# Step 2: Create prediction data (from the full dataset)
prediction_data <- svi_monthly %>%
  mutate(predicted_ntl = predict(model_varying_slopes)) %>%
  filter(TRACTCE %in% significant_tracts)  # Step 3: keep only significant tracts for plotting

# Step 4: Plot
ggplot(prediction_data, aes(x = months_since_fire, y = predicted_ntl, color = factor(TRACTCE))) +
  geom_line(size = 1.2) +
  labs(
    title = "Predicted avg_ntl Over Time for Significant Interaction Tracts",
    x = "Months Since Fire",
    y = "Predicted avg_ntl",
    color = "TRACTCE"
  ) +
  theme_minimal()


```

```{r}
# Model 1: log regression of months since fire and avg_ntl, with tract fixed effects
svi_monthly <- read.csv("~/Local/Dissertation/NTL_Wildfire_Recovery/svi_monthly.csv")

model1_fe <- lm(avg_ntl ~ log1p(months_since_fire) + factor(TRACTCE) + E_TOTPOP, data = svi_monthly)
summary(model1_fe)

# Add fitted values to your original data
svi_monthly <- svi_monthly %>%
  mutate(predicted_ntl = predict(model1_fe))

# Plot predicted avg_ntl over time by tract
ggplot(svi_monthly, aes(x = months_since_fire, y = predicted_ntl, group = TRACTCE)) +
  geom_line(alpha = 0.5) +
  labs(
    title = "Predicted Nighttime Light (NTL) Over Time by Census Tract",
    x = "Months Since Fire",
    y = "Predicted Average NTL"
  ) +
  theme_minimal()


```

```{r}

# Model 2: log regression of months since fire and avg_ntl with tracts fixed effects and SVI themes as moderator 
library(lme4)

model3_mixed <- lm(avg_ntl ~ log1p(months_since_fire) * RPL_THEMES + factor(TRACTCE) + E_TOTPOP, data = svi_monthly)
summary(model3_mixed)


library(ggplot2)
library(dplyr)

# Get coefficients from the model
coefs <- coef(model3_mixed)
intercept <- coefs["(Intercept)"]
b_months <- coefs["log1p(months_since_fire)"]
b_svi <- coefs["RPL_THEMES"]
b_interaction <- coefs["log1p(months_since_fire):RPL_THEMES"]

# Create a prediction dataset
months <- 0:35
svi_levels <- c(0.2, 0.8)

plot_data <- expand.grid(
  months_since_fire = months,
  RPL_THEMES = svi_levels
) %>%
  mutate(
    log_months = log1p(months_since_fire),
    predicted_ntl = intercept +
                    b_months * log_months +
                    b_svi * RPL_THEMES +
                    b_interaction * log_months * RPL_THEMES
  )

ggplot(plot_data, aes(x = months_since_fire, y = predicted_ntl, color = as.factor(RPL_THEMES))) +
  geom_line(size = 1.2) +
  labs(
    title = "Predicted NTL Over Time by SVI Score",
    x = "Months Since Fire",
    y = "Predicted avg_ntl",
    color = "SVI Score"
  ) +
  scale_color_manual(values = c("steelblue", "firebrick"),
                     labels = c("Low SVI (0.2)", "High SVI (0.8)")) +
  theme_minimal() +
  theme(text = element_text(size = 12))





```